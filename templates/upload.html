{% extends "base.html" %}

{% block page_styles %}
<style>
    .upload-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 160px); /* Adjust based on navbar and padding height */
        text-align: center;
    }
    .upload-box {
        background: #fff; 
        padding: 40px; 
        border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        width: 100%;
        max-width: 500px;
    }
    .upload-box h2 {
        margin-top: 0;
        color: #343a40;
    }
    #upload-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    #upload-form input[type="file"] { 
        border: 1px solid #ccc; 
        padding: 10px; 
        border-radius: 4px; 
    }
    #upload-form button { 
        background-color: #007bff; 
        color: white; 
        padding: 12px 15px; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 16px; 
        font-weight: 500;
    }
    #upload-form button:hover { 
        background-color: #0056b3; 
    }
    #progress-bar-container { 
        width: 100%; 
        background-color: #e9ecef; 
        border-radius: 4px; 
        margin-top: 20px; 
        display: none; 
    }
    #progress-bar { 
        width: 0%; 
        height: 20px; 
        background-color: #007bff; 
        border-radius: 4px; 
        text-align: center; 
        color: white; 
        line-height: 20px;
        transition: width 0.4s ease;
    }
    #status { 
        margin-top: 20px; 
        font-size: 16px; 
        color: #495057; 
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="upload-box">
        <h2>Upload Products CSV</h2>
        <form id="upload-form" enctype="multipart/form-data">
            <input type="file" name="file" accept=".csv" required />
            <button type="submit">Upload and Process</button>
        </form>

        <div id="progress-bar-container">
            <div id="progress-bar">0%</div>
        </div>
        <div id="status">Select a file and click "Upload" to begin.</div>
    </div>
</div>

<script>
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        var statusDiv = document.getElementById('status');
        var progressBarContainer = document.getElementById('progress-bar-container');
        var progressBar = document.getElementById('progress-bar');
        var fileInput = this.querySelector('input[type="file"]');

        if (!fileInput.files || fileInput.files.length === 0) {
            statusDiv.textContent = 'Please select a file to upload.';
            statusDiv.style.color = 'red';
            return;
        }

        statusDiv.textContent = 'Uploading...';
        statusDiv.style.color = '#495057';
        progressBarContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.textContent = 'Error: ' + data.error;
                statusDiv.style.color = 'red';
                progressBarContainer.style.display = 'none';
                return;
            }
            statusDiv.textContent = 'Processing...';
            pollTaskStatus(data.task_id);
        })
        .catch(error => {
            console.error('Error:', error);
            statusDiv.textContent = 'Upload failed. See console for details.';
            statusDiv.style.color = 'red';
            progressBarContainer.style.display = 'none';
        });
    });

    function pollTaskStatus(taskId) {
        var statusDiv = document.getElementById('status');
        var progressBarContainer = document.getElementById('progress-bar-container');
        var progressBar = document.getElementById('progress-bar');

        var interval = setInterval(() => {
            fetch(`/status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    statusDiv.textContent = data.status;
                    
                    if (data.progress) {
                        var percent = data.progress;
                        progressBar.style.width = percent + '%';
                        progressBar.textContent = percent + '%';
                    }

                    if (data.state === 'SUCCESS') {
                        clearInterval(interval);
                        statusDiv.textContent = 'Import complete!';
                        statusDiv.style.color = 'green';
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                         setTimeout(() => { // Redirect after a short delay
                            window.location.href = "{{ url_for('list_products') }}";
                        }, 1000);
                    } else if (data.state === 'FAILURE') {
                        clearInterval(interval);
                        statusDiv.textContent = 'Import failed: ' + data.status;
                        statusDiv.style.color = 'red';
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    console.error('Error polling status:', error);
                    statusDiv.textContent = 'Error fetching status. See console.';
                    statusDiv.style.color = 'red';
                });
        }, 2000); // Poll every 2 seconds
    }
</script>
{% endblock %}