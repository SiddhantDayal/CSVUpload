{% extends "base.html" %}

{% block page_styles %}
<style>
    .upload-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 160px); /* Adjust based on navbar and padding height */
        text-align: center;
    }
    .upload-box {
        background: #fff; 
        padding: 40px; 
        border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        width: 100%;
        max-width: 500px;
    }
    .upload-box h2 {
        margin-top: 0;
        color: #343a40;
    }
    #upload-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    #upload-form input[type="file"] { 
        border: 1px solid #ccc; 
        padding: 10px; 
        border-radius: 4px; 
    }
    #upload-form button { 
        background-color: #007bff; 
        color: white; 
        padding: 12px 15px; 
        border: none; 
        border-radius: 4px; 
        cursor: pointer; 
        font-size: 16px; 
        font-weight: 500;
    }
    #upload-form button:hover { 
        background-color: #0056b3; 
    }
    #upload-form button:disabled {
        background-color: #cccccc; /* Greyed out */
        cursor: not-allowed;
    }
    #progress-bar-container { 
        width: 100%; 
        background-color: #e9ecef; 
        border-radius: 4px; 
        margin-top: 20px; 
        /* display: none; */ /* Managed by JS now */
    }
    #progress-bar { 
        width: 0%; 
        height: 20px; 
        background-color: #007bff; 
        border-radius: 4px; 
        text-align: center; 
        color: white; 
        line-height: 20px;
        transition: width 0.4s ease;
    }
    #status { 
        margin-top: 20px; 
        font-size: 16px; 
        color: #495057; 
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="upload-box">
        <h2>Upload Products CSV</h2>
        <form id="upload-form" enctype="multipart/form-data">
            <input type="file" name="file" accept=".csv" required />
            <button type="submit">Upload and Process</button>
        </form>

        <div id="progress-bar-container" style="display: none;">
            <div id="progress-bar">0%</div>
        </div>
        <div id="status">Select a file and click "Upload" to begin.</div>
    </div>
</div>

<script>
    const uploadForm = document.getElementById('upload-form');
    const fileInput = uploadForm.querySelector('input[type="file"]');
    const submitButton = uploadForm.querySelector('button[type="submit"]');
    const statusDiv = document.getElementById('status');
    const progressBarContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');

    function setFormEnabled(enabled) {
        submitButton.disabled = !enabled;
        if (enabled) {
            submitButton.textContent = 'Upload and Process';
            progressBarContainer.style.display = 'none';
            statusDiv.textContent = 'Select a file and click "Upload" to begin.';
            statusDiv.style.color = '#495057';
        } else {
            submitButton.textContent = 'Processing...';
            progressBarContainer.style.display = 'block';
        }
        // File input state is managed separately or left enabled
    }

    // Function to clear task_id from session on backend
    function clearUploadSession() {
        fetch('/clear-upload-session', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (!data.success) console.error('Failed to clear upload session on backend.');
            })
            .catch(error => console.error('Error clearing upload session:', error));
    }

    function pollTaskStatus(taskId) {
        let interval = setInterval(() => {
            fetch(`/check-upload-status`) // Use check-upload-status to leverage session tracking
                .then(response => response.json())
                .then(data => {
                    // console.log("Polling response:", data);
                    if (data.status === "no_active_upload" || data.state === undefined || data.state === 'REVOKED') {
                        // Task ID cleared from session or task not found, implies completion/failure from backend cleanup
                        clearInterval(interval);
                        setFormEnabled(true);
                        statusDiv.textContent = 'No active upload found. Ready for new upload.';
                        statusDiv.style.color = '#495057';
                        return;
                    }

                    statusDiv.textContent = data.status;
                    
                    if (data.progress !== undefined) {
                        let percent = data.progress;
                        progressBar.style.width = percent + '%';
                        progressBar.textContent = percent + '%';
                    } else if (data.state === 'PENDING') {
                        progressBar.style.width = '0%';
                        progressBar.textContent = '0%';
                    }

                    if (data.state === 'SUCCESS') {
                        clearInterval(interval);
                        statusDiv.textContent = 'Import complete!';
                        statusDiv.style.color = 'green';
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        clearUploadSession(); // Clear session on successful completion
                         setTimeout(() => { // Redirect after a short delay
                            window.location.href = "{{ url_for('list_products') }}";
                        }, 1000);
                    } else if (data.state === 'FAILURE') {
                        clearInterval(interval);
                        statusDiv.textContent = 'Import failed: ' + data.status;
                        statusDiv.style.color = 'red';
                        clearUploadSession(); // Clear session on failure
                        setFormEnabled(true); // Re-enable form
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    console.error('Error polling status:', error);
                    statusDiv.textContent = 'Error fetching status. See console.';
                    statusDiv.style.color = 'red';
                    clearUploadSession(); // Clear session on network error during polling
                    setFormEnabled(true); // Re-enable form
                });
        }, 2000); // Poll every 2 seconds
    }

    // --- On page load, check for active upload ---
    document.addEventListener('DOMContentLoaded', function() {
        // Do NOT disable form initially. Assume enabled.
        progressBarContainer.style.display = 'none'; // Hide progress container by default
        statusDiv.textContent = 'Checking for active uploads...'; // Initial message

        fetch('/check-upload-status')
            .then(response => response.json())
            .then(data => {
                // console.log("Initial check response:", data);
                if (data.status === "no_active_upload" || data.state === 'SUCCESS' || data.state === 'FAILURE' || data.state === 'REVOKED') {
                    // No active upload, or task completed/failed/revoked in background
                    setFormEnabled(true); // Ensure form is enabled
                    statusDiv.textContent = data.status === "no_active_upload" ? 'Ready for new upload.' : `Last upload: ${data.status}`;
                    statusDiv.style.color = data.state === 'FAILURE' ? 'red' : '#495057';
                    progressBarContainer.style.display = 'none'; // Hide if no active upload
                } else {
                    // Active upload found, disable submit button and start polling
                    setFormEnabled(false); // Disable submit button
                    statusDiv.textContent = data.status;
                    if (data.progress !== undefined) {
                        progressBar.style.width = data.progress + '%';
                        progressBar.textContent = data.progress + '%';
                    }
                    progressBarContainer.style.display = 'block'; // Show progress bar
                    pollTaskStatus(data.task_id); // task_id comes with data from check-upload-status if active
                }
            })
            .catch(error => {
                console.error('Error on initial upload status check:', error);
                statusDiv.textContent = 'Error checking for active upload. Ready for new upload.';
                statusDiv.style.color = 'red';
                setFormEnabled(true); // Re-enable form on error
                progressBarContainer.style.display = 'none';
            });
    });

    // --- Form submission for new upload ---
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Disable submit button immediately on submission to prevent double submission
        setFormEnabled(false);
        progressBarContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        if (!fileInput.files || fileInput.files.length === 0) {
            statusDiv.textContent = 'Please select a file to upload.';
            statusDiv.style.color = 'red';
            setFormEnabled(true); // Re-enable if no file selected
            progressBarContainer.style.display = 'none';
            return;
        }

        statusDiv.textContent = 'Uploading...';
        statusDiv.style.color = '#495057';
        
        var formData = new FormData(this);
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                statusDiv.textContent = 'Error: ' + data.error;
                statusDiv.style.color = 'red';
                progressBarContainer.style.display = 'none';
                setFormEnabled(true);
                return;
            }
            statusDiv.textContent = 'Processing...';
            pollTaskStatus(data.task_id);
        })
        .catch(error => {
            console.error('Error:', error);
            statusDiv.textContent = 'Upload failed. See console for details.';
            statusDiv.style.color = 'red';
            progressBarContainer.style.display = 'none';
            setFormEnabled(true);
        });
    });

</script>
{% endblock %}